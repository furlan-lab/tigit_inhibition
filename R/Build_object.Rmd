---
title: "Build single cell GEX object"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
  editor_options: 
    chunk_output_type: console
  chunk_output_type: console
---

#################################################################################################################################
Single cell data/analysis used for:
TIGIT inhibition and lenalidomide synergistically promote anti-myeloma immune responses after stem cell transplantation in mice

Written by: Olivia Waltner, Scott Furlan
Data generated by: Simone Minnie, Shruti Bhise

Any questions regarding the analysis email: owaltner@fredhutch.org

#################################################################################################################################


```{r, include =F}
rm(list=ls())
knitr::opts_chunk$set( echo = TRUE, message=FALSE, warning=FALSE, fig.width=8 )
ROOT_DIR<-"/fh/fast/furlan_s/grp/experiments/648_Tigitdata"
DATA_DIR <- file.path(ROOT_DIR, "data")     
RES_DIR  <- file.path(ROOT_DIR,  "res")     
RMD_DIR  <- file.path(ROOT_DIR,"rmd")     
CDS_DIR <- file.path(ROOT_DIR,   "cds")
FIG_DIR <- file.path(ROOT_DIR,  "figs")

suppressPackageStartupMessages({
  library(monocle3)
  library(dplyr)
  library(Matrix)
  library(reticulate)
  library(ggplot2)
  library(pals)
  library(RColorBrewer)
  library(Seurat)
  library(ComplexHeatmap)
  library(ArchR)
  library(Biobase)
  library(stringr)
  library(viridis)
  library(Seurat)
  library(scCustomize)
  library(scRepertoire)
  library(parallel)
  library(forcats)
  library(ggalluvial)
})

set.seed(1234)

##loading viewmastR package
dyn.load('/app/software/ArrayFire/3.8.1/lib64/libaf.so.3')
library(RcppArrayFire)
library(viewmastR) 

#using Seurat in parallel
plan("multisession", workers = 12)
options(future.globals.maxSize = 6000000 * 1024^2)
```

#get filtered aggreagate cellranger data 
```{r}
cds<-load_cellranger_data_h5(DATA_DIR, samplenames = c("648_Tigit"), aggregated = T)
ccol<-pals::glasbey(n=15)
names(ccol)<-levels(pData(cds)$sample_id)
cds<-estimate_size_factors(cds)
cds<-detect_genes(cds)
cds<-calculate_gene_dispersion(cds)
```

## UMI per cell per sample
```{r, echo=F}
pData(cds)$n_umi<-colSums(exprs(cds))
pData(cds)$n_gene<-apply(exprs(cds), 2, function(col) {
  as.numeric(col)
  length(which(col!=0))})
pData(cds)$log_umi<-log(pData(cds)$n.umi, base=10)
qc<-data.frame(umi_per_cell=pData(cds)$n_umi, sample=pData(cds)$sample_id, gene_per_cell=pData(cds)$n_gene, log_umi=pData(cds)$log_umi)

ggplot(qc, aes(x=umi_per_cell, fill=sample))+
  geom_density(alpha=0.4)+scale_fill_manual(values=ccol)

ggplot(qc, aes(x=log_umi, fill=sample))+
  geom_density(alpha=0.4)+scale_fill_manual(values=ccol)
```

# Intitial Dimensionality Reduction
```{r, echo=F}
cds<-select_genes(cds, fit_min = 1.03, logmean_ll = -6.5)
plot_gene_dispersion(cds)
cds<-preprocess_cds(cds, num_dim = 50,  verbose = T, use_genes = get_ordering_genes(cds))
```

#Add QC metadata
```{r}
mito.genes <- fData(cds)$id[grep(pattern = "^mt-", x = fData(cds)$gene_short_name)]
pData(cds)$percent.mito <- Matrix::colSums(exprs(cds[mito.genes, ]))/Matrix::colSums(exprs(cds))

quantile(pData(cds)$percent.mito , c(0.05, .5, .95))

pData(cds)$likely_dead <- pData(cds)$percent.mito>0.15
```


The top 20 PCs will be fed into UMAP...
```{r, echo=F, include=F}
cds<-reduce_dimension(cds, reduction_method = "UMAP", num_dim = 20, verbose=T, cores=detectCores())
cds<-cluster_cells(cds, resolution = 3e-4, verbose=F)
```

# QC Plots on UMAP embedding
```{r}
plot_cells(cds, color_cells_by = "percent.mito", label_cell_groups = F)
plot_cells(cds, color_cells_by = "likely_dead", label_cell_groups = F)
plot_cells(cds, color_cells_by = "n.umi", label_cell_groups = F)
```

#Initial QC
```{r, echo=F}
lt<-log10(2500)
ht<-log10(25000)
ggplot(qc, aes(x=log_umi, fill=sample))+
  geom_density(alpha=0.4)+scale_fill_manual(values=ccol)+geom_vline(xintercept = c(lt, ht))

cdsT<-cds[,pData(cds)$log_umi>lt & pData(cds)$log_umi < ht]
cdsT<-cdsT[,!pData(cdsT)$likely_dead]

plot_cells(cdsT, color_cells_by = "percent.mito", label_cell_groups = F)

cdsT<-select_genes(cdsT,  logmean_ll = -6, top_n = 2000)
cdsT<-preprocess_cds(cdsT, num_dim = 50,  verbose = T, use_genes = get_selected_genes(cdsT))
cdsT<-reduce_dimension(cdsT, reduction_method = "UMAP", num_dim = 25, verbose=T, cores=2)
```

```{r, echo=F, include=F}
cdsT<-cluster_cells(cdsT, resolution = 3e-4, verbose=T)
```

# Remove satellite clusters that don't/lowly express Cd3e
```{r}
plot_cells(cdsT, color_cells_by = "partition",  label_cell_groups = F, cell_size = 0.3)
plot_cells(cdsT, genes = "Cd3e")
plot_cells(cdsT, genes = "Cd4")
plot_cells(cdsT, genes = "Cd8a")

cds<-cdsT[,partitions(cdsT) %in% c(1,2)]
plot_cells(cds, color_cells_by = "cluster",  label_cell_groups = F, cell_size = 0.3)

cds<-select_genes(cds,  logmean_ll = -6, top_n = 2000)
cds<-preprocess_cds(cds, num_dim = 20,  verbose = T, use_genes = get_selected_genes(cds))
cds<-reduce_dimension(cds, reduction_method = "UMAP", num_dim = 15, verbose=T, cores=2)
cds<-cluster_cells(cds, resolution = 3e-4, verbose=T)

plot_cells(cds, color_cells_by = "partition",  label_cell_groups = F, cell_size = 0.3)

cds<-cds[,partitions(cds) %in% c(1)]
cds<-select_genes(cds,  logmean_ll = -6, top_n = 2000)
cds<-preprocess_cds(cds, num_dim = 20,  verbose = T, use_genes = get_selected_genes(cds))
cds<-reduce_dimension(cds, reduction_method = "UMAP", num_dim = 15, verbose=T, cores=2)
cds<-cluster_cells(cds, resolution = 3e-6, verbose=T)

##getting rid of the little group of cells
cds<-choose_cells(cds)
cds<-select_genes(cds,  logmean_ll = -6, top_n = 2000)
cds<-preprocess_cds(cds, num_dim = 20,  verbose = T, use_genes = get_selected_genes(cds))
cds<-reduce_dimension(cds, reduction_method = "UMAP", num_dim = 10, verbose=T, cores=2, umap.save_model = file.path(RES_DIR, "umap_model"))
cds<-cluster_cells(cds, resolution = 2e-4, verbose=T)
colData(cds)$cluster<-clusters(cds)   
p<-plot_cells(cds, color_cells_by = "sample_id", label_cell_groups = F, cell_size = 1)+scale_color_manual(values = paletteDiscrete(levels(factor(cds$sample_id)), set = "grove"))+NoAxes()

t<-plot_cells(cds, color_cells_by = "cluster", label_cell_groups = F, cell_size = 1)+scale_color_manual(values = paletteDiscrete(levels(factor(clusters(cds))), set = "circus", reverse = T))+NoAxes()+facet_wrap(~sample_id)

p
```

#Save object
```{r}
#saveRDS(cds, file.path(CDS_DIR, "tigit_cds.rds"))
```


